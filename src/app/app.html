<!-- ERROR/SUCCESS MESSAGES -->
<div class="message error-message" *ngIf="errorMessage">
  Error: {{ errorMessage }}
</div>

<div class="message success-message" *ngIf="successMessage">
  Success: {{ successMessage }}
</div>

<!-- STEP 1 -->
<div class="step-card">
  <h3>Step 1: Upload Excel File</h3>
  <p>Select an Excel file (.xls or .xlsx) by dragging, clicking, or pasting (Ctrl+V).</p>

  <div
    class="drop-zone"
    [class.dragging]="isDragging"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
    (click)="fileInput.click()"
  >
    <p *ngIf="!fileName">
      Drag & drop Excel file here<br />
      <small>or click to upload or paste file (Ctrl+V)</small>
    </p>

    <p *ngIf="fileName">
      Selected file:
      <strong>{{ fileName }}.xlsx</strong>
    </p>

    <input
      #fileInput
      type="file"
      accept=".xls,.xlsx,.xlsm,.xlsb,.csv,.tsv,.txt,.xml,.ods"
      hidden
      (change)="onFileChange($event)"
    />
  </div>
</div>

<!-- UPLOAD PROGRESS -->
<div class="step-card progress-card" *ngIf="isUploading">
  <h3>Uploading File...</h3>
  <div class="progress-bar-container">
    <div class="progress-bar-fill" [style.width.%]="uploadProgress"></div>
  </div>
  <p class="progress-text">{{ uploadProgress }}% uploaded</p>
</div>

<!-- STEP 2 -->
<div class="step-card" *ngIf="fileName && sheetNames.length > 1">
  <h3>Step 2: Select Sheet</h3>
  <p>Choose the sheet you want to clean.</p>

  <label>Sheet:</label>
  <select [(ngModel)]="selectedSheet" (change)="previewSheet()">
    <option *ngFor="let s of sheetNames" [value]="s">
      {{ s }}
    </option>
  </select>
</div>

<!-- STEP 3 -->
<div class="step-card" *ngIf="showPreview && previewData.length">
  <h3>Step 3: Select Header Row</h3>
  <p>Click <strong>Header</strong> on the row that contains column names.</p>

  <div class="preview-table">
    <table>
      <tr
        *ngFor="let row of previewData; let i = index"
        [class.header-selected]="headerRowIndex === i"
      >
        <td>
          <button
            (click)="setHeaderRow(i)"
            [style.background]="headerRowIndex === i ? '#38b2ac' : ''"
            [style.color]="headerRowIndex === i ? 'white' : ''"
            [style.border-color]="headerRowIndex === i ? '#38b2ac' : ''"
          >
            Header
          </button>
        </td>
        <td *ngFor="let cell of row">
          {{ cell }}
        </td>
      </tr>
    </table>
  </div>
</div>

<!-- STEP 4 -->
<div class="step-card" *ngIf="headers.length">
  <h3>Step 4: Select Mobile Columns</h3>
  <p>Select one or more columns that contain mobile numbers.</p>

  <div class="mobile-columns">
    <label *ngFor="let h of headers; let i = index">
      <input
        type="checkbox"
        [checked]="selectedColumns.includes(i)"
        (change)="toggleColumn(i)"
      />
      <strong *ngIf="selectedColumns.includes(i)">Selected</strong>
      {{ h }}
    </label>
  </div>
</div>

<!-- STEP 5 -->
<div class="step-card" *ngIf="headers.length">
  <h3>Step 5: Export Options</h3>
  <p>Choose how you want to export the cleaned data.</p>

  <div class="export-options">
    <label>
      <input type="radio" name="exportMode" [(ngModel)]="exportMode" value="full" />
      Full Data (all columns with cleaned numbers)
    </label>
    <label>
      <input type="radio" name="exportMode" [(ngModel)]="exportMode" value="unique" />
      Unique Numbers Only (single column, no duplicates)
    </label>
    <label>
      <input type="radio" name="exportMode" [(ngModel)]="exportMode" value="mobile-name" />
      Mobile Number & Name (two columns, no duplicates)
    </label>
    <label>
      <input type="radio" name="exportMode" [(ngModel)]="exportMode" value="keep-all" />
      Keep All Rows (do not delete rows, only clean valid numbers)
    </label>
  </div>

  <div *ngIf="exportMode === 'mobile-name'" style="margin-top: 15px;">
    <p>Select the column that contains names:</p>
    <div class="mobile-columns">
      <label *ngFor="let h of headers; let i = index">
        <input
          type="radio"
          name="nameColumn"
          [value]="i"
          [checked]="selectedNameColumn === i"
          (change)="selectedNameColumn = i"
        />
        <strong *ngIf="selectedNameColumn === i">Selected</strong>
        {{ h }}
      </label>
    </div>
  </div>
</div>

<!-- STEP 6 -->
<div class="step-card" *ngIf="headers.length">
  <h3>Step 6: Clean & Download</h3>
  <p *ngIf="exportMode !== 'keep-all'">
    Invalid rows will be removed. Duplicates will be filtered. Empty mobile cells may be auto-filled using
    valid numbers from the same row.
  </p>
  <p *ngIf="exportMode === 'keep-all'">
    No rows will be removed. The app will only clean numbers that can be normalized and keep other values unchanged.
  </p>

  <button
    class="primary-btn"
    (click)="cleanAndDownload()"
    [disabled]="isProcessing"
  >
    {{ isProcessing ? `Processing... ${progress}%` : 'Clean Mobile Numbers & Download' }}
  </button>
</div>

<!-- PROCESSING PROGRESS -->
<div class="step-card progress-card" *ngIf="isProcessing && progress > 0">
  <h3>Processing...</h3>
  <div class="progress-bar-container">
    <div class="progress-bar-fill" [style.width.%]="progress"></div>
  </div>
  <p class="progress-text">{{ progress }}% complete - {{ progress < 100 ? 'Please wait...' : 'Generating file...' }}</p>
</div>

<!-- STATISTICS -->
<div class="step-card stats-card" *ngIf="showStats">
  <h3>Cleaning Statistics</h3>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">Total Rows</div>
    </div>
    <div class="stat-item success">
      <button type="button" class="stat-download-btn" (click)="downloadStatReport('valid')">
        <div class="stat-value">{{ stats.valid }}</div>
        <div class="stat-label">Valid Numbers</div>
      </button>
    </div>
    <div class="stat-item warning">
      <button type="button" class="stat-download-btn" (click)="downloadStatReport('duplicates')">
        <div class="stat-value">{{ stats.duplicates }}</div>
        <div class="stat-label">Duplicates Removed</div>
      </button>
    </div>
    <div class="stat-item error">
      <button type="button" class="stat-download-btn" (click)="downloadStatReport('invalidPattern')">
        <div class="stat-value">{{ stats.invalidPattern }}</div>
        <div class="stat-label">Invalid Patterns</div>
      </button>
    </div>
    <div class="stat-item error">
      <button type="button" class="stat-download-btn" (click)="downloadStatReport('invalidLength')">
        <div class="stat-value">{{ stats.invalidLength }}</div>
        <div class="stat-label">Invalid Length/Format</div>
      </button>
    </div>
  </div>
</div>
